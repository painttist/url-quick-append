"use strict";var urlIn=document.getElementById("url-input"),btnClean=document.getElementById("btn-clean"),btnCleanUndo=document.getElementById("btn-undo"),btnGo=document.getElementById("btn-go"),btnDropdownLinks=document.getElementById("btn-dropdown-links"),panelDropdown=document.getElementById("panel-dropdown-links"),overlayDel=document.getElementById("overlay-delete"),btnOverlayCheck=document.getElementById("btn-overlay-check"),btnOverlayClose=document.getElementById("btn-overlay-close"),divLinkSelected=document.getElementById("display-link-selected");const cacheKey="url-quick-append-cache",keywords=["密码","提取码","密碼","提取碼"];var theurl,lazyLoading=!0,urls=[],urlsName=[];btnGo.disabled=!0;var oldOpts=getCachedOpts(),selectedID=oldOpts.id,urlInText=oldOpts.urlInText,infoText=oldOpts.infoText;function getCachedOpts(){var e=localStorage.getItem(cacheKey);return e?JSON.parse(e):{id:0,urlInText:"",infoText:void 0}}function clearCache(){localStorage.removeItem(cacheKey)}function recordOpts(e){var n=getCachedOpts();localStorage.setItem(cacheKey,JSON.stringify(Object.assign({},n,e)))}function recordID(){recordOpts({id:selectedID})}function recordUrlInText(){recordOpts({urlInText:urlIn.value})}function recordInfoText(){recordOpts({infoText:infoText})}function getURLs(){chrome.storage.sync.get("urlsInfo",function(e){urls=e.urlsInfo.urls,urlsName=e.urlsInfo.urlsName,btnGo.disabled=!1,appendURLList()})}function setURLs(){chrome.storage.sync.set({urlsInfo:{urls:urls,urlsName:urlsName}},function(){})}function getOptions(){chrome.storage.sync.get("options",function(e){lazyLoading=e.options.lazyLoading})}function setDefaultURLs(){chrome.storage.sync.set({urlsInfo:{urlsName:["Google Search","Youtube Search","Bilibili Search","Bilibili ID","Bilibili Up","Baidu Drive","Pixiv ID","Pixiv Artists","Youtube ID","Yande.re ID"],urls:["https://www.google.com/search?q=","https://www.youtube.com/results?search_query=","https://search.bilibili.com/all?keyword=","https://www.bilibili.com/video/av","https://space.bilibili.com/","https://pan.baidu.com/s/","https://www.pixiv.net/member_illust.php?mode=medium&illust_id=","https://www.pixiv.net/member.php?id=","https://www.youtube.com/watch?v=","https://yande.re/post/show/"]}},function(){})}function getElemIndex(e){return Array.from(e.parentNode.children).indexOf(e)}function getAbsoluteHeight(e){e="string"==typeof e?document.querySelector(e):e;var n=window.getComputedStyle(e),t=parseFloat(n.marginTop)+parseFloat(n.marginBottom);return Math.ceil(e.offsetHeight+t)}function goToURL(){urlIn.value.split("\n").forEach(function(e,n){theurl=urls[selectedID]+e,lazyLoading?chrome.tabs.create({url:chrome.extension.getURL("lazyloading.html#")+theurl,selected:!1}):chrome.tabs.create({url:theurl,selected:!1})})}selectedID=null==selectedID?0:selectedID,urlInText=null==urlInText?"":urlInText,infoText=null==infoText?[]:infoText,btnDropdownLinks.addEventListener("click",function(){event.target.classList.contains("icon-add")?appendNewLink():toggleDropdown()});var beforeUndoUrlsInText,linksList=document.getElementsByClassName("link");function appendURLList(){urls.forEach(function(e,n){appendToPanelDropdown(n)}),appendAddLink(),changeLink(selectedID)}function appendNewLink(){panelDropdown.removeChild(panelDropdown.lastChild),urlsName.push("Name"),urls.push("URL");var e=appendToPanelDropdown(urls.length-1);e.children[1].classList.toggle("icon-mode_edit"),e.children[1].classList.toggle("icon-check"),e.children[0].readOnly=!e.children[0].readOnly,e.children[0].focus(),e.children[0].select(),e.children[3].classList.toggle("edit"),e.classList.toggle("edit"),changeLink(getElemIndex(e)),appendAddLink(),scrollTo(panelDropdown,panelDropdown.scrollHeight-panelDropdown.offsetHeight,250)}function appendAddLink(){var e=document.createElement("div");e.classList="line link",e.setAttribute("tabindex","-1"),e.addEventListener("click",appendNewLink);var n=document.createElement("span");n.classList="link-btn-add icon-add",n.innerHTML=" Add",e.appendChild(n),panelDropdown.appendChild(e)}function linkDelete(e){panelDropdown.children[e].classList.add("removed"),urls.splice(e,1),urlsName.splice(e,1),setURLs(),scrollToLink(e>0?e-1:0),panelDropdown.children[e].addEventListener("transitionend",function(){this.remove()})}function linkOnClick(e){var n=e.target,t=getElemIndex(e.currentTarget);n.classList.contains("link-btn-delete")?(selectedID=t,overlayDel.classList.toggle("on")):n.classList.contains("link-btn-edit")?toggleLinkEdit(t):n.classList.contains("link-name")||n.classList.contains("link-url")?(changeLink(t),n.parentNode.classList.contains("edit")||(tabDeselectLink(t),urlIn.focus(),urlIn.select(),toggleDropdown())):n.classList.contains("link")&&(urlsName[t]=e.target.children[0].value,urls[t]=e.target.children[3].value,setURLs(),changeLink(t),n.classList.contains("edit")||(tabDeselectLink(t),urlIn.focus(),urlIn.select(),toggleDropdown()))}function linkOnMouseOver(e){changeLink(getElemIndex(e.currentTarget))}function appendToPanelDropdown(e){var n=document.createElement("div");n.classList="line link",n.setAttribute("tabindex","-1"),n.addEventListener("mouseover",linkOnMouseOver),n.addEventListener("click",linkOnClick);var t=document.createElement("input");t.id="link-input-name",t.classList="line-first link-input link-name",t.value=urlsName[e],t.readOnly=!0;var o=document.createElement("input");o.id="link-input-url",o.classList="link-input link-url",o.value=urls[e];var l=document.createElement("span");l.classList="link-btn-delete icon-delete";var i=document.createElement("span");return i.classList="link-btn-edit icon-mode_edit",n.appendChild(t),n.appendChild(i),n.appendChild(l),n.appendChild(o),panelDropdown.appendChild(n),n}function displayLink(e){divLinkSelected.innerHTML=urlsName[e]}function changeLink(e){tabDeselectLink(selectedID=loop(selectedID,0,urls.length-1)),tabSelectLink(selectedID=loop(e,0,urls.length-1)),displayLink(selectedID),recordID()}function loop(e,n,t){return e<n?t:e>t?n:e}function toggleDropdown(){btnDropdownLinks.classList.toggle("expanded"),panelDropdown.classList.toggle("show"),panelDropdown.classList.contains("show")?document.getElementById("dropdown-icon").classList="icon-expand_less":document.getElementById("dropdown-icon").classList="icon-expand_more",setURLs()}function clearSelection(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()}function isDropDownOpen(){return btnDropdownLinks.classList.contains("expanded")}function undoClearInput(){btnCleanUndo.classList.add("hidden"),urlIn.value=beforeUndoUrlsInText,recordUrlInText(),urlIn.focus(),updateCleanButton(),autoExpand(urlIn)}overlayDel.addEventListener("click",function(){event.target.classList.contains("btn-overlay")?event.target.classList.contains("icon-check")?(linkDelete(selectedID),overlayDel.classList.toggle("on")):event.target.classList.contains("icon-close")&&overlayDel.classList.toggle("on"):event.target.classList.contains("overlay")&&overlayDel.classList.toggle("on")}),document.addEventListener("input",function(e){"textarea"===e.target.tagName.toLowerCase()&&(recordUrlInText(),updateCleanButton(),btnCleanUndo.classList.add("hidden"),autoExpand(e.target))},!1),btnClean.onclick=cleanInput,btnCleanUndo.onclick=undoClearInput;const regKey=RegExp("["+keywords.join("")+"]{2,3} *:+ *\\S*","gm"),regKeySingle=RegExp("["+keywords.join("")+"]{2,3} *:+ *\\S*"),regColonClean=/[\s\S]*:+ */g,regColon=/\S*:+ *[^:\s]+/g,regEmptyDes=/[\S]*:+ */g;function cleanInput(){beforeUndoUrlsInText=urlIn.value;var e=urlIn.value;if(e){var n=(e=e.replace("：",":")).match(regKey);e=e.replace(regKey," "),console.log("regKey"),console.log(e),e=e.replace(/\/$/gm,""),console.log("Ending /"),console.log(e),e=e.replace(/\/\s/g," "),console.log("Ending / + space"),console.log(e),e=e.replace(/(\S*\/)+/g,"\n"),console.log("Front URL"),console.log(e);var t=e.match(regColon);e=e.replace(regColon," "),console.log("regColon"),console.log(e);e.match(regEmptyDes);e=e.replace(regEmptyDes,""),console.log("regEmptyDes"),console.log(e);var o=[];n&&(o=o.concat(n)),t&&(o=o.concat(t)),o&&o.forEach(function(e,n){var t=e.replace(regColonClean,"");t.length>0&&infoText.push(t)});var l=e.match(/\S+/g);l?l.join("\n"):l="",refreshInfo(),recordInfoText(),urlIn.value=l,btnCleanUndo.classList.remove("hidden"),recordUrlInText(),updateCleanButton(),urlIn.focus(),autoExpand(urlIn)}}function updateCleanButton(){checkInputToClean()?(urlIn.classList.add("toClean"),btnClean.classList.remove("hidden")):(urlIn.classList.remove("toClean"),btnClean.classList.add("hidden"))}function checkInputToClean(){var e=urlIn.value;return!!e.match("/")||(e.replace("：",":").match(regColon)?(console.log("True"),!0):e.match(regKeySingle)?(console.log("True"),!0):(console.log("False"),!1))}var autoExpand=function(e){var n=parseInt(e.style.height,10);e.style.height="inherit";var t=window.getComputedStyle(e),o=(parseInt(e.clientHeight,10),parseInt(t.getPropertyValue("line-height"),10)),l=o+parseInt(t.getPropertyValue("padding-top"),10)+parseInt(t.getPropertyValue("padding-bottom"),10),i=parseInt(t.getPropertyValue("max-height"),10),s=e.scrollHeight-l+o;if(s>n&&s>i){var a=s-l-o;e.scrollTop=a}e.style.height=s+"px"};function scrollTo(e,n,t){var o=e.scrollTop,l=n-o,i=0,s=function(){i+=20;var n=Math.easeInOutQuad(i,o,l,t);e.scrollTop=n,i<t&&setTimeout(s,20)};s()}function tabSelectLink(e){panelDropdown.children[e].setAttribute("data-selected","true")}function tabDeselectLink(e){panelDropdown.children[e].setAttribute("data-selected","false")}function switchLinkInputFocus(e){var n=e.parentNode,t=n.children[0],o=(n.children[1],n.children[2],n.children[3]);document.activeElement==t?(o.focus(),o.select()):(t.focus(),t.select())}function scrollToLink(e){var n=panelDropdown.children[e],t=n.offsetTop-2*getAbsoluteHeight(n)+n.offsetHeight;scrollTo(panelDropdown,t,250)}Math.easeInOutQuad=function(e,n,t,o){return(e/=o/2)<1?t/2*e*e+n:-t/2*(--e*(e-2)-1)+n};var isTabKeyDown=!1,isTabQuickSelected=!1;function toggleLinkEdit(e){var n=panelDropdown.children[e],t=n.children[0],o=n.children[1],l=(n.children[2],n.children[3]);o.classList.contains("icon-check")&&(document.getSelection().removeAllRanges(),urlsName[e]=t.value,urls[e]=l.value,setURLs(),urlIn.focus()),o.classList.toggle("icon-mode_edit"),o.classList.toggle("icon-check"),t.readOnly=!t.readOnly,t.readOnly?clearSelection():t.select(),l.classList.toggle("edit"),n.classList.toggle("edit")}function displayInfo(){if(!(infoText.length<=0)){var e=document.getElementById("line-info-container");infoText.forEach(function(n,t){var o=document.createElement("button");o.classList.add("btn-info"),o.innerHTML=n,e.appendChild(o)}),Array.from(document.getElementsByClassName("btn-info")).forEach(function(e,n){e.onclick=function(){copyToClipboard(this.innerHTML),removeInfoText(this.innerHTML),urlIn.focus(),this.innerHTML="Copied",this.style.width=this.clientWidth,this.onclick=function(e){e.target.remove()};var e=this;setTimeout(function(){e.classList.add("toShrink")},500),this.addEventListener("transitionend",function(e){"width"==e.propertyName?e.target.remove():e.target.classList.add("toShrinkWidth")})}})}}function animateCSS(e,n,t){const o="object"==typeof e?e:document.querySelector(e);o.classList.add("animated",n),o.addEventListener("animationend",function e(){o.classList.remove("animated",n),o.removeEventListener("animationend",e),"function"==typeof t&&t(o)})}function clearInfo(){document.getElementById("line-info-container").innerHTML=""}function refreshInfo(){clearInfo(),displayInfo()}function removeInfoText(e){var n=infoText.indexOf(e);n>-1&&infoText.splice(n,1),recordInfoText()}document.addEventListener("keyup",function(e){var n=document.activeElement;9==e.keyCode&&(e.preventDefault(),isTabKeyDown=!1,isTabQuickSelected?isTabQuickSelected=!1:e.shiftKey?isDropDownOpen()?toggleLinkEdit(selectedID):(toggleLinkEdit(selectedID),toggleDropdown(),changeLink(selectedID),scrollToLink(selectedID)):isDropDownOpen()?n.classList.contains("link-input")?switchLinkInputFocus(n):(changeLink(selectedID+1),scrollToLink(selectedID)):(toggleDropdown(),changeLink(selectedID),scrollToLink(selectedID)))}),document.addEventListener("keydown",function(e){var n=document.activeElement;if(isTabKeyDown){e.preventDefault();var t=String.fromCharCode(e.keyCode);if(t.match(/\S/)){isTabQuickSelected=!0;var o=0;t==urlsName[selectedID][0]&&(o=loop(selectedID+1,0,urlsName.length-1));for(var l=o;l<o+urlsName.length;l++){var i=l%urlsName.length;if(urlsName[i][0].toUpperCase()==t)return changeLink(i),void scrollToLink(selectedID)}}}9==e.keyCode&&(e.preventDefault(),isTabKeyDown=!0),13==e.keyCode&&(n.classList.contains("link-input")?(e.preventDefault(),toggleLinkEdit(getElemIndex(n.parentNode))):"textarea"==n.tagName.toLowerCase()&&e.shiftKey&&(e.preventDefault(),checkInputToClean()?cleanInput():goToURL()))}),String.prototype.isEmpty=function(){return 0===this.length||!this.trim()};const copyToClipboard=e=>{const n=document.createElement("textarea");n.value=e,n.setAttribute("readonly",""),n.style.position="absolute",n.style.left="-9999px",document.body.appendChild(n);const t=document.getSelection().rangeCount>0&&document.getSelection().getRangeAt(0);n.select(),document.execCommand("copy"),document.body.removeChild(n),t&&(document.getSelection().removeAllRanges(),document.getSelection().addRange(t))};getOptions(),getURLs(),urlIn.value=urlInText,urlIn.focus(),urlIn.select(),autoExpand(urlIn),updateCleanButton(),autoExpand(urlIn),btnGo.onclick=goToURL,urlIn.addEventListener("focus",function(){setTimeout(function(){urlIn.select()},3)}),displayInfo();